<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA Teachable Machine</title>
    
    <!-- Charger TensorFlow.js AVANT Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #preview { max-width: 300px; margin: 10px auto; display: block; }
        #label-container div { font-size: 18px; margin-top: 5px; }
        #status { font-size: 18px; font-weight: bold; margin-top: 10px; color: blue; }
    </style>
</head>
<body>
    <h1>Test de l'IA Teachable Machine</h1>
    <p id="status">Chargement du mod√®le...</p>
    <input type="file" id="imageUpload" accept="image/*" onchange="previewFile()">
    <img id="preview" style="display: none;">
    <div id="label-container"></div>

    <script>
        let model, maxPredictions;
    
        async function init() {
            const statusElement = document.getElementById("status");
            statusElement.textContent = "Chargement du mod√®le...";
    
            if (typeof tmImage === "undefined") {
                console.error("tmImage n'est pas charg√© !");
                statusElement.textContent = "Erreur : Teachable Machine non charg√©.";
                return;
            }
    
            const URL = "http://127.0.0.1:8000/"; // Mets ici l'URL correcte
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
    
            try {
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                statusElement.textContent = "Mod√®le charg√© avec succ√®s.";
            } catch (error) {
                console.error("Erreur lors du chargement du mod√®le :", error);
                statusElement.textContent = "√âchec du chargement du mod√®le.";
            }
        }

        function previewFile() {
            const file = document.getElementById("imageUpload").files[0];
            const preview = document.getElementById("preview");
            const reader = new FileReader();

            if (!file) {
                alert("Aucune image s√©lectionn√©e.");
                return;
            }
            document.getElementById("label-container").innerHTML = "";
            console.log("Fichier s√©lectionn√© :", file);

            reader.onloadend = function () {
                preview.src = reader.result;
                preview.style.display = "block";
                preview.onload = () => {
                console.log("Image affich√©e, lancement de la pr√©diction...");
                predict(preview);
                }
                console.log("Image affich√©e, lancement de la pr√©diction...");
                predict(preview);
            };
            if (file) {
                reader.readAsDataURL(file);
            } else {
                alert("Aucune image s√©lectionn√©e.");
            }
}

async function predict(imageElement) {
    if (!model) {
        console.error("Mod√®le non charg√©.");
        alert("Le mod√®le n'est pas encore charg√©.");
        return;
    }

    // üöÄ V√©rification que l'image est bien un √©l√©ment HTMLImageElement
    if (!(imageElement instanceof HTMLImageElement)) {
        console.error("L'√©l√©ment fourni n'est pas une image valide.");
        alert("Erreur : L'image fournie n'est pas valide.");
        return;
    }

    try {
        console.log("Lancement de la pr√©diction...");
        const prediction = await model.predict(imageElement);
        console.log("R√©sultat de la pr√©diction :", prediction);

        const labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = ""; 

        prediction.forEach(pred => {
            const div = document.createElement("div");
            div.innerHTML = `${pred.className}: ${(pred.probability * 100).toFixed(2)}%`;
            labelContainer.appendChild(div);
        });

    } catch (error) {
        console.error("Erreur lors de la pr√©diction :", error);
        alert("Erreur lors de l'ex√©cution du mod√®le.");
    }

    // üöÄ R√©initialiser le champ fichier apr√®s la pr√©diction
    document.getElementById("imageUpload").value = "";
}

    
        window.onload = init;
    </script>
</body>
</html>
